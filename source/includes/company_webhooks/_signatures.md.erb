# Webhook Signatures

To validate the authenticity of webhooks sent by Teamtailor, each request includes a `TT-Signature` header and a signature field in the payload. This allows you to verify the webhook came from Teamtailor.

Teamtailor supports two signature versions:
- **v1** (legacy): This version is deprecated and will be removed in the future
- **v2** (recommended): This is the current version and should be used for all new implementations

You can configure the signature version in your webhook settings. **We strongly recommend using v2 for all new integrations.**

## Signature Format

The signature is a Base64-encoded string. The format depends on the signature version:

### v1 Signature (Legacy - Deprecated)
```
"signature": "YzU1N2FhOTUwMjlkNTFiMGM5NjIxNTEyODc5NGY5ZjgxZWNkMmNkZTZhNmIxYmI2YmM3NmVmYmQ1ZGZiMDg0Zg=="
```

### v2 Signature (Recommended)
```
"signature": "dD0xNzAxMjM0NTY3LHYyPWFiY2RlZjEyMzQ1Njc4OTBhYmNkZWYxMjM0NTY3ODkwYWJjZGVmMTIzNDU2Nzg5MA=="
```

When decoded, the v2 signature contains a timestamp and the HMAC:
```
t=1701234567,v2=abcdef1234567890abcdef1234567890abcdef1234567890
```

## Signature Verification

### v1 Signature Verification (Legacy - Deprecated)

<aside class="warning">
v1 signatures are deprecated and will be removed in the future. Please migrate to v2 signatures for all new integrations.
</aside>

#### JavaScript Example

```javascript
const crypto = require('crypto');

// Get this from your webhook setup in Teamtailor
const SECRET_KEY = 'your_webhook_signature_key';

function verifyWebhookSignature(requestBody, signatureHeader) {
  const { payload } = requestBody;

  // Calculate expected signature
  const hmac = crypto.createHmac('sha256', SECRET_KEY)
    .update(payload.data.id.toString())
    .digest('hex');

  const expectedSignature = Buffer.from(hmac).toString('base64');

  // Compare signatures
  return signatureHeader === expectedSignature;
}

// In your webhook handler
app.post('/webhook', (req, res) => {
  const signature = req.headers['tt-signature'];

  if (!verifyWebhookSignature(req.body, signature)) {
    return res.status(401).send('Invalid signature');
  }

  // Process the webhook...
  res.status(200).send('Webhook processed');
});
```

#### PHP Example

```php
<?php
// Get this from your webhook setup in Teamtailor
$secretKey = 'your_webhook_signature_key';

function verifySignature($requestBody, $signatureHeader, $secretKey) {
    $id = $requestBody['payload']['data']['id'];

    // Calculate the HMAC using SHA-256
    $hmac = hash_hmac('sha256', $id, $secretKey, true);

    // Convert to base64
    $expectedSignature = base64_encode(bin2hex($hmac));

    return hash_equals($signatureHeader, $expectedSignature);
}

// Webhook handler
$requestBody = json_decode(file_get_contents('php://input'), true);
$signature = $_SERVER['HTTP_TT_SIGNATURE'];

if (!verifySignature($requestBody, $signature, $secretKey)) {
    http_response_code(401);
    echo 'Invalid signature';
    exit;
}

// Process the webhook...
http_response_code(200);
echo 'Webhook processed';
```

### v2 Signature Verification (Recommended)

The v2 signature provides enhanced security by including a timestamp and signing the entire payload.

<aside class="warning">
<strong>Critical:</strong> You must use the raw request body (before JSON parsing) to verify the signature. Do NOT re-serialize the parsed JSON payload with <code>JSON.stringify()</code> or <code>json_encode()</code>, as different programming languages serialize JSON differently (e.g., Ruby may serialize integers with decimal points). The signature was created using the raw body, so you must verify it using the same raw body.
</aside>

#### JavaScript Example

```javascript
const crypto = require('crypto');
const express = require('express');

const app = express();

// Get this from your webhook setup in Teamtailor
const SECRET_KEY = 'your_webhook_signature_key';

// IMPORTANT: Use express.raw() to get the raw request body
// Do NOT use express.json() for webhook endpoints
app.use('/webhook', express.raw({ type: 'application/json' }));

function verifyV2Signature(rawBody, signatureHeader) {
  // Decode the signature
  const decodedSignature = Buffer.from(signatureHeader, 'base64').toString('utf-8');

  // Parse timestamp and signature from the decoded string
  // Format: t=1701234567,v2=abcdef...
  const parts = decodedSignature.split(',');
  if (parts.length !== 2) return false;

  const timestamp = parts[0].split('=')[1];
  const receivedHmac = parts[1].split('=')[1];

  if (!timestamp || !receivedHmac) return false;

  // Create the signed payload: timestamp + '.' + raw request body
  // Convert raw body buffer to string
  const rawBodyString = rawBody.toString('utf8');
  const signedPayload = `${timestamp}.${rawBodyString}`;

  // Calculate expected HMAC
  const expectedHmac = crypto.createHmac('sha256', SECRET_KEY)
    .update(signedPayload)
    .digest('hex');

  // Compare HMACs using constant-time comparison
  return crypto.timingSafeEqual(
    Buffer.from(receivedHmac),
    Buffer.from(expectedHmac)
  );
}

// Webhook handler
app.post('/webhook', (req, res) => {
  const signature = req.headers['tt-signature'];

  if (!verifyV2Signature(req.body, signature)) {
    return res.status(401).send('Invalid signature');
  }

  // Parse the JSON body after signature verification
  const webhookData = JSON.parse(req.body.toString('utf8'));

  // Process the webhook...
  res.status(200).send('Webhook processed');
});
```

#### PHP Example

```php
<?php
// Get this from your webhook setup in Teamtailor
$secretKey = 'your_webhook_signature_key';

function verifyV2Signature($rawBody, $signatureHeader, $secretKey) {
    // Decode the signature
    $decodedSignature = base64_decode($signatureHeader);

    // Parse timestamp and signature from the decoded string
    // Format: t=1701234567,v2=abcdef...
    $parts = explode(',', $decodedSignature);

    if (count($parts) !== 2) {
        return false;
    }

    $timestampPart = explode('=', $parts[0]);
    $hmacPart = explode('=', $parts[1]);

    if (count($timestampPart) !== 2 || count($hmacPart) !== 2) {
        return false;
    }

    $timestamp = $timestampPart[1];
    $receivedHmac = $hmacPart[1];

    // Create the signed payload: timestamp + '.' + raw request body
    $signedPayload = $timestamp . '.' . $rawBody;

    // Calculate expected HMAC
    $expectedHmac = hash_hmac('sha256', $signedPayload, $secretKey);

    // Compare HMACs using constant-time comparison
    return hash_equals($receivedHmac, $expectedHmac);
}

// Webhook handler
// Get the raw request body BEFORE parsing it
$rawBody = file_get_contents('php://input');
$signature = $_SERVER['HTTP_TT_SIGNATURE'];

if (!verifyV2Signature($rawBody, $signature, $secretKey)) {
    http_response_code(401);
    echo 'Invalid signature';
    exit;
}

// Parse the JSON body after signature verification
$webhookData = json_decode($rawBody, true);

// Process the webhook...
http_response_code(200);
echo 'Webhook processed';
```